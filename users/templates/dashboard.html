<!-- dashboard.html -->

{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard | Chess Coach{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-page">
    <div class="dashboard-header">
        <div class="user-info">
            <h1>Welcome, <span class="highlight-username">{{ current_username }}</span></h1>
        </div>

        <div class="action-buttons">
            <a href="#" class="btn primary-btn secondary-btn coach-btn">
                <i class="fas fa-robot"></i> Chat with Coach
            </a>
        </div>
    </div>

    <div class="game-history-section">
        <div class="history-header">
            <h2>Last Games</h2>
        
        <div class="filter-bar">
            <input type="text" placeholder="Search by Opponent or Date (e.g 2025-09-29)..." class="search-input">
        </div>
        </div>

        <div class="game-table-container">
            <table class="game-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Game Type</th>
                        <th>Players</th>
                        <th>Result</th>
                        <th>Moves</th>
                        <th>Accuracy</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in games %}
                    <tr>
                        <td>{{ game.date }}</td>
                        <td>{{ game.time_control }}</td>

                        <td class="player-details-cell">
                            <div class="player-line white-player">
                                <span class="color-indicator"></span>
                                <span>{{ game.player_top }}</span> </div>
                            
                            <div class="player-line black-player">
                                <span class="color-indicator"></span>
                                <span>{{ game.player_bottom }}</span> </div>
                        </td>

                        {% if "Win" in game.result_description %}
                            <td class="result-win">{{ game.result_description }}</td>
                        {% elif "Loss" in game.result_description %}
                            <td class="result-loss">{{ game.result_description }}</td>
                        {% else %}
                            <td class="result-draw">{{ game.result_description }}</td>
                        {% endif %}

                        <td>{{ game.moves_count }}</td>

                        <td>
                            <form action="{% url 'analysis:analyze_game' %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="game_id" value="{{ game.pk }}">
                                <button type="submit" class="btn small-btn analyze-btn">Analyze</button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="no-games">
                            You have no game played or the data could not be retrieved.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if not games %}
            <p class="mt-4 text-center">
                Your game history could not be loaded or the game could not be found.
            </p>
        {% endif %}
    </div>
    <div class="load-more-controls">
            <p class="loading-message" style="display: none; text-align: center;">Loading...</p>
            
            <button id="load-more-btn" class="btn primary-btn small-btn">
                <i class="fas fa-redo"></i> Load More Games
            </button>
            
            <button id="collapse-btn" class="btn secondary-btn small-btn" style="display: none;">
                <i class="fas fa-angle-up"></i> Collapse View
            </button>
        </div>
        {% if not games %}
        {% endif %}
    </div>
</div>

{% block extra_js %}

<script>
    const searchGamesUrl = "{% url 'users:search_games' %}";
    const analyzeGameUrl = "{% url 'analysis:analyze_game' %}";
    const loadMoreGamesUrl = "{% url 'users:load_more_games' %}"; 
</script>
<script src="{% static 'js/dashboard.js' %}"></script>

{% endblock %}

{% endblock %}